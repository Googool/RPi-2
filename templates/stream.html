<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Stream</title>
    <link rel="shortcut icon" href="{{ url_for('static', filename='favicon.png') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
    <script src="{{ url_for('static', filename='vendor/socket.io.min.js') }}"></script>
    <script src="{{ url_for('static', filename='main.js') }}" defer></script>
  </head>
  <body>
    <div class="container">
      <!-- Sidebar -->
      <aside class="sidebar" role="complementary" aria-label="Sidebar">
        <div class="sidebar-header">
          <a class="logo-svg" aria-label="logo" href="{{ url_for('main.index') }}">
            <img src="{{ url_for('static', filename='eiva-logo.svg') }}" alt="EIVA logo" class="logo-img" width="200" height="44" decoding="async">
          </a>
        </div>
          <div class="device-info card" data-sys-card>
            <h3>System</h3>
            <div>Host: <span data-hostname>—</span></div>
            <div>CPU: <span data-cpu>—</span></div>
            <div>RAM: <span data-ram>—</span></div>
            <div>Disk: <span data-disk>—</span></div>
          </div>
        <div class="sidebar-footer">
          <div class="bottom-logo" aria-label="Powered by Raspberry Pi">
            <img src="{{ url_for('static', filename='rpi-logo.svg') }}" alt="Raspberry Pi logo" class="logo-img" width="200" height="44" decoding="async" loading="lazy">
          </div>
        </div>
      </aside>
      <!-- Top navigation -->
      <header class="topbar" role="navigation" aria-label="Top navigation">
        <nav class="topnav">
          <a href="/logs" class="nav-item active">Logs</a>
          <a href="/serial" class="nav-item active">Serial</a>
        </nav>
      </header>
      <main class="main-content" role="main">
        <pre class="logbox term" id="log" aria-live="polite" data-live="{{ 'true' if live else 'false' }}" data-mode="logs" data-download="{{ download_url or '' }}">{{ initial }}</pre>
        <!-- Actions -->
        <div class="main-actions">
          {% if download_url %}
          <a class="btn" href="{{ download_url }}">Download</a>
          {% endif %}
          {% if files %}
          <div class="dropup">
            <button class="btn secondary" id="pickerBtn" aria-haspopup="menu" aria-expanded="false">Browse</button>
            <div class="menu" id="pickerMenu" role="menu" aria-label="Choose item">
              {% set base = picker_base or '/stream/logs' %}
              {% for f in files %}
              <a class="menu-item {{ 'active' if f == current_name else '' }}" href="{{ base }}/{{ f }}" role="menuitem">{{ f }}</a>
              {% endfor %}
            </div>
          </div>
          {% endif %}
        </div>
      </main>
      <!-- Bottom bar -->
      <footer class="bottombar" role="contentinfo" aria-label="Bottom bar">
        <div>Prototype: Remolade Rune v0.1</div>
      </footer>
    </div>
    <script>
    (() => {
      const out = document.getElementById('log');
      if (!out) return;

      // Are we on the live (today) log?
      const isLive = String(out.dataset.live || '').toLowerCase() === 'true';

      // --- Dropup controller (unchanged) ---
      const pickerBtn  = document.getElementById('pickerBtn');
      const pickerMenu = document.getElementById('pickerMenu');
      if (pickerBtn && pickerMenu) {
        let open = false;
        const items = Array.from(pickerMenu.querySelectorAll('.menu-item'));
        const setOpen = (v) => {
          open = !!v;
          pickerBtn.setAttribute('aria-expanded', String(open));
          pickerMenu.style.display = open ? 'block' : 'none';
        };
        setOpen(false);

        pickerBtn.addEventListener('click', (e) => {
          e.preventDefault();
          setOpen(!open);
          if (open && items[0]) items[0].focus();
        });
        document.addEventListener('click', (e) => {
          if (!open) return;
          if (!pickerMenu.contains(e.target) && !pickerBtn.contains(e.target)) setOpen(false);
        });
        document.addEventListener('keydown', (e) => {
          if (!open) return;
          if (e.key === 'Escape') setOpen(false);
        });
        pickerMenu.addEventListener('keydown', (e) => {
          const i = items.indexOf(document.activeElement);
          if (e.key === 'ArrowDown') { e.preventDefault(); (items[i+1] || items[0])?.focus(); }
          if (e.key === 'ArrowUp')   { e.preventDefault(); (items[i-1] || items.at(-1))?.focus(); }
        });
      }

      // --- Log stream with smart follow + viewport preserving ---
      const MAX_CHARS  = 200000;
      const KEEP_CHARS = 150000;

      const distFromBottom = () => out.scrollHeight - out.clientHeight - out.scrollTop;

      // Hysteresis: unpin when >=60px, re-pin when <=5px
      let pinned = isLive; // start pinned for live view
      function onScroll() {
        const d = distFromBottom();
        if (d <= 5) pinned = isLive && true;
        else if (d >= 60) pinned = false;
      }
      out.addEventListener('scroll', onScroll);

      function append(line) {
        if (!line) return;

        const wasPinned = pinned;
        const prevTop   = out.scrollTop;
        const prevH     = out.scrollHeight;

        if (out.textContent && !out.textContent.endsWith('\n')) out.textContent += '\n';
        out.textContent += (line.endsWith('\n') ? line : line + '\n');

        // Trim from the top if too large; keep viewport stable
        let removedPx = 0;
        if (out.textContent.length > MAX_CHARS) {
          const beforeH = out.scrollHeight;
          const s = out.textContent;
          const startIdx = Math.max(0, s.length - KEEP_CHARS);
          const nl = s.indexOf('\n', startIdx);
          out.textContent = s.slice(nl > -1 ? nl + 1 : startIdx);
          const afterH = out.scrollHeight;
          removedPx = Math.max(0, beforeH - afterH);
        }

        if (wasPinned) {
          out.scrollTop = out.scrollHeight;           // keep following tail
        } else if (removedPx > 0) {
          out.scrollTop = Math.max(0, prevTop - removedPx); // preserve view after trim
        } else {
          out.scrollTop = prevTop;                    // keep position
        }
      }

      // Start pinned to bottom on load
      out.scrollTop = out.scrollHeight;
      pinned = true;

      // --- Socket.IO: only connect for live view ---
      if (isLive) {
        if (window.io) {
          const socket = io({ transports: ['polling'], upgrade: false, path: '/socket.io' });

          // Events (support both names just in case)
          socket.on('log_line', ({ line }) => append(line));
          socket.on('log', (p) => append((p && (p.line || p.message)) ?? String(p)));

          window.addEventListener('beforeunload', () => {
            socket.removeAllListeners();
            socket.close();
          });
        } else {
          append('[socket.io client not available — live stream disabled]');
        }
      }
    })();
    </script>
  </body>
</html>
